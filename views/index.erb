<div class="container-fluid location-find">
  <div class="row">
    <div class="col">
      <input id="search" class="form-control" type="text" name="" value="">
    </div>
    <div class="col">
      <button id="find" class="btn btn-primary" type="button" onclick="getLocation()">Location</button>
    </div>
  </div>
</div>
<div id="map"></div>

<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
</script>
<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDQ63rTQob19owHv4jyFA63zJ4DPgEczTw&callback=initMap&libraries=places">
</script>
<script>
var map;
var zoomLevel = 17;
var centerMarker;

function initMap() {
    initAutoComplete();
    map = new google.maps.Map(document.getElementById('map'), {
    zoom: zoomLevel,
    center: {lat: -37.815031, lng: 144.967005} ,
  });
  centerMarker = new google.maps.Marker({
          map: map,
          position: {lat: -37.815031, lng: 144.967005}
        });
  var markers = locations.map(function(location, i) {
    return new google.maps.Marker({
      position: location,
      icon: "https://maps.google.com/mapfiles/kml/shapes/parking_lot_maps.png"
    });
  });

  var markerCluster = new MarkerClusterer(map, markers,
    {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});

  }

  var locations = [];
  var carSpots = <%= @search_carspots.to_json %>
  carSpots.forEach(function(carspot){
    var latitude = carspot.lat
    var longitude = carspot.lon
    locations.push({lat: parseFloat(latitude), lng: parseFloat(longitude)});
  });

  function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition);
    }
}

function showPosition(position) {
   map.setCenter({lat: position.coords.latitude, lng: position.coords.longitude})
   map.setZoom(zoomLevel);

   centerMarker = new google.maps.Marker({
           map: map,
           position: {lat: position.coords.latitude, lng: position.coords.longitude}
         });
}

function initAutoComplete(){
  var defaultBounds = new google.maps.LatLngBounds(
    new google.maps.LatLng(-37.785314, 145.033092),
    new google.maps.LatLng(-37.862693, 144.881693));

    var input = document.getElementById('search');
    var options = {
      bounds: defaultBounds,
      types: ['address']
    };

    autocomplete = new google.maps.places.Autocomplete(input, options);

    autocomplete.addListener('place_changed', function(){
      var place = autocomplete.getPlace();
      map.setCenter(place.geometry.location);
      map.setZoom(zoomLevel);

      centerMarker = new google.maps.Marker({
              map: map,
              position: place.geometry.location
            });
    });
}


  </script>
